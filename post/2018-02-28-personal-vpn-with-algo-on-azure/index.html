<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Personal Vpn with Algo on Azure</title>
  <meta property="og:title" content="Personal Vpn with Algo on Azure" />
  <meta name="twitter:title" content="Personal Vpn with Algo on Azure" />
  <meta name="description" content="Deploy a personal VPN. Because VPN providers are expensive crap.">
  <meta property="og:description" content="Deploy a personal VPN. Because VPN providers are expensive crap.">
  <meta name="twitter:description" content="Deploy a personal VPN. Because VPN providers are expensive crap.">
  <meta name="author" content="Gabriele Teotino"/>
  <link href='https://www.teosoft.it/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://www.teosoft.it/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://www.teosoft.it/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.teosoft.it/post/2018-02-28-personal-vpn-with-algo-on-azure/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Bluish capsule" />

  <meta name="generator" content="Hugo 0.36.1" />
  <link rel="canonical" href="https://www.teosoft.it/post/2018-02-28-personal-vpn-with-algo-on-azure/" />
  <link rel="alternate" href="https://www.teosoft.it/index.xml" type="application/rss+xml" title="Bluish capsule">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.teosoft.it/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://www.teosoft.it/css/highlight.min.css" /><link rel="stylesheet" href="https://www.teosoft.it/css/codeblock.css" />



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-24994854-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.teosoft.it/">Bluish capsule</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/post">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Notes" href="/note">Notes</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                  <a href="/project">Projects home</a>
                
                  <a href="/project/meccanici">Meccanici</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="Reviews" href="/review">Reviews</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Bluish capsule" href="https://www.teosoft.it/">
            <img class="avatar-img" src="https://www.teosoft.it/img/avatar-icon.png" alt="Bluish capsule" />
          </a>
        
      </div>
    </div>

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search Bluish capsule</h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Personal Vpn with Algo on Azure</h1>
                
                  
                    <h2 class="post-subheading">Deploy a personal VPN. Because VPN providers are expensive crap.</h2>
                  
                
                
                  <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp;Posted on February 28, 2018
  
  
  &nbsp;|&nbsp;
  <i class="fa fa-clock-o"></i> 14 minutes (2929 words)
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Let&rsquo;s create a VPN server on Azure (other cloud providers are supported).</p>

<p></p>

<h1 id="algo-setup">Algo setup</h1>

<p><a href="https://github.com/trailofbits/algo">Algo</a> github repository.
<a href="https://blog.trailofbits.com/2016/12/12/meet-algo-the-vpn-that-works/">Algo</a> product description.</p>

<p>Clone the repository</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">git clone https://github.com/trailofbits/algo.git
<span class="nb">cd</span> algo</code></pre></div>
<p>Install dependencies</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt-get update <span class="o">&amp;&amp;</span> sudo apt-get install <span class="se">\
</span><span class="se"></span>    build-essential <span class="se">\
</span><span class="se"></span>    libssl-dev <span class="se">\
</span><span class="se"></span>    libffi-dev <span class="se">\
</span><span class="se"></span>    python-dev <span class="se">\
</span><span class="se"></span>    python-pip <span class="se">\
</span><span class="se"></span>    python-setuptools <span class="se">\
</span><span class="se"></span>    python-virtualenv -y</code></pre></div>
<p>The remaining python dependencies</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">python -m virtualenv env <span class="o">&amp;&amp;</span> <span class="nb">source</span> env/bin/activate <span class="o">&amp;&amp;</span> python -m pip install -U pip <span class="o">&amp;&amp;</span> python -m pip install -r requirements.txt</code></pre></div>
<p><em>Note: the installation took about 100Mb</em></p>

<p>Open <em>config.cfg</em> with a text editor and add as many users as you need.</p>

<p>Run algo and follow the instructions on screen.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">./algo</code></pre></div>
<h1 id="azure-setup">Azure setup</h1>

<p><a href="https://github.com/trailofbits/algo/blob/master/docs/cloud-azure.md">Official guide</a></p>

<p>From the <a href="https://portal.azure.com/">Azure Portal</a> go to <strong>Azure Active Directory</strong>.
Select <strong>App registrations</strong> and click <strong>New Application Registration</strong>.</p>

<p>Fill the form</p>

<ul>
<li>Name: algo-personal-vpn <em>(it can be any name)</em></li>
<li>Application type: Web app / API</li>
<li>Sign-on URL: <a href="https://www.teosoft.it">https://www.teosoft.it</a> <em>(it can be any URL)</em></li>
</ul>

<p>Copy and save somewhere the <em>Application ID</em>.</p>

<p>Click on <strong>Settings</strong>, <strong>Keys</strong>, add a <em>Key description</em> like <em>algo</em> (it will be the name of the virtual machine) with <em>Never expires</em>. Click save. Copy and save somewhere the <em>Value</em> (this is the <em>Secret ID</em>).</p>

<p>Go to the Main menu, <strong>Azure Active Directory</strong> and click on <strong>Properties</strong>. Copy and save somewhere the <em>Directory ID</em> (in the script it will be referred as <em>tenant</em>).</p>

<p>Go to the Main menu, <strong>Subscriptions</strong> and click on the subscription you want you use in Algo. Copy and save the <em>Subscription ID</em>.</p>

<p>Inside the <strong>Subscription</strong> go to <strong>Acces Control</strong> add a new item, select &ldquo;Contributor&rdquo;. Search for <em>algo-personal-vpn</em>, add it as a member and <strong>Save</strong>.</p>

<p>Now insert the values inside the script to continue with the wizard.</p>

<p>Optionally create a credentials file <code>~/.azure/credentials</code>:</p>
<div class="highlight"><pre class="chroma">[default]
client_id=
secret=
tenant=
subscription_id=</pre></div>
<h2 id="wizard">Wizard</h2>

<p>The wizard will ask some question and procede to create a <em>Basic A0 (1 vcpu, 0.75 GB memory)</em> with the name <em>algo</em>. The pricing is actually 0,015 €/hour or 11,08 €/month.</p>

<p>Here is the result of a test run</p>
<div class="highlight"><pre class="chroma">What provider would you like to use?
  1. DigitalOcean
  2. Amazon EC2
  3. Microsoft Azure
  4. Google Compute Engine
  5. Install to existing Ubuntu 16.04 server

Enter the number of your desired provider
: 3

Enter your azure secret id (https://github.com/trailofbits/algo/blob/master/docs/cloud-azure.md)
You can skip this step if you want to use your defaults credentials from ~/.azure/credentials
[pasted values will not be displayed]
[...]:

Enter your azure tenant id (https://github.com/trailofbits/algo/blob/master/docs/cloud-azure.md)
You can skip this step if you want to use your defaults credentials from ~/.azure/credentials
[pasted values will not be displayed]
[...]:

Enter your azure client id (application id) (https://github.com/trailofbits/algo/blob/master/docs/cloud-azure.md)
You can skip this step if you want to use your defaults credentials from ~/.azure/credentials
[pasted values will not be displayed]
[...]:

Enter your azure subscription id (https://github.com/trailofbits/algo/blob/master/docs/cloud-azure.md)
You can skip this step if you want to use your defaults credentials from ~/.azure/credentials
[pasted values will not be displayed]
[...]:

Name the vpn server:
[algo]:


What region should the server be located in? (https://azure.microsoft.com/en-us/regions/)
  1.  South Central US
  2.  Central US
  3.  North Europe
  4.  West Europe
  5.  Southeast Asia
  6.  Japan West
  7.  Japan East
  8.  Australia Southeast
  9.  Australia East
  10. Canada Central
  11. West US 2
  12. West Central US
  13. UK South
  14. UK West
  15. West US
  16. Brazil South
  17. Canada East
  18. Central India
  19. East Asia
  20. Germany Central
  21. Germany Northeast
  22. Korea Central
  23. Korea South
  24. North Central US
  25. South India
  26. West India
  27. East US
  28. East US 2

Enter the number of your desired region:
[1]: 4

Do you want macOS/iOS clients to enable &#34;VPN On Demand&#34; when connected to cellular networks?
[y/N]:

Do you want macOS/iOS clients to enable &#34;VPN On Demand&#34; when connected to Wi-Fi?
[y/N]:

Do you want to install a DNS resolver on this VPN server, to block ads while surfing?
[y/N]:

Do you want each user to have their own account for SSH tunneling?
[y/N]:

Do you want to apply operating system security enhancements on the server? (warning: replaces your sshd_config)
[y/N]:

Do you want the VPN to support Windows 10 or Linux Desktop clients? (enables compatible ciphers and key exchange, less secure)
[y/N]:

Do you want to retain the CA key? (required to add users in the future, but less secure)
[y/N]:

PLAY [Configure the server] ****************************************************

TASK [setup] *******************************************************************
ok: [localhost]

TASK [Generate the SSH private key] ********************************************
changed: [localhost]

TASK [Generate the SSH public key] *********************************************
ok: [localhost]

TASK [Change mode for the SSH private key] *************************************
ok: [localhost]

TASK [Ensure the dynamic inventory exists] *************************************
changed: [localhost]

TASK [cloud-azure : set_fact] **************************************************
ok: [localhost]

TASK [cloud-azure : Create a resource group] ***********************************
changed: [localhost]

TASK [cloud-azure : Create a virtual network] **********************************
changed: [localhost]

TASK [cloud-azure : Create a security group] ***********************************
changed: [localhost]

TASK [cloud-azure : Create a subnet] *******************************************
changed: [localhost]

TASK [cloud-azure : Create an instance] ****************************************
changed: [localhost]

TASK [cloud-azure : set_fact] **************************************************
ok: [localhost]

TASK [cloud-azure : Ensure the network interface includes all required parameters] ***
changed: [localhost]

TASK [cloud-azure : Add the instance to an inventory group] ********************
changed: [localhost]

TASK [cloud-azure : set_fact] **************************************************
ok: [localhost]

TASK [cloud-azure : Ensure the group azure exists in the dynamic inventory file] ***
changed: [localhost]

TASK [cloud-azure : Populate the dynamic inventory] ****************************
changed: [localhost]

TASK [Wait until SSH becomes ready...] *****************************************
ok: [localhost]

TASK [A short pause, in order to be sure the instance is ready] ****************
Pausing for 20 seconds
(ctrl+C then &#39;C&#39; = continue early, ctrl+C then &#39;A&#39; = abort)
ok: [localhost]

TASK [Ensure the local ssh directory is exist] *********************************
ok: [localhost]

TASK [Copy the algo ssh key to the local ssh directory] ************************
changed: [localhost]

PLAY [Configure the server and install required software] **********************

TASK [Check the system] ********************************************************
changed: [13.80.20.110]

TASK [Ubuntu | Install prerequisites] ******************************************
changed: [13.80.20.110]

TASK [Ubuntu | Configure defaults] *********************************************
changed: [13.80.20.110]

TASK [FreeBSD / HardenedBSD | Install prerequisites] ***************************
skipping: [13.80.20.110]

TASK [FreeBSD / HardenedBSD | Configure defaults] ******************************
skipping: [13.80.20.110]

TASK [set_fact] ****************************************************************
skipping: [13.80.20.110]

TASK [Gather Facts] ************************************************************
ok: [13.80.20.110]

TASK [Ensure the algo ssh key exist on the server] *****************************
changed: [13.80.20.110]

TASK [Enable IPv6] *************************************************************
skipping: [13.80.20.110]

TASK [Set facts if the deployment in a cloud] **********************************
ok: [13.80.20.110]

TASK [Generate password for the CA key] ****************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [Generate p12 export password] ********************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [Define password facts] ***************************************************
ok: [13.80.20.110]

TASK [Define the commonName] ***************************************************
ok: [13.80.20.110]

TASK [common : Install software updates] ***************************************
changed: [13.80.20.110]

TASK [common : Check if reboot is required] ************************************
changed: [13.80.20.110]

TASK [common : Reboot] *********************************************************
skipping: [13.80.20.110]

TASK [common : Wait until SSH becomes ready...] ********************************
skipping: [13.80.20.110]

TASK [common : Disable MOTD on login and SSHD] *********************************
changed: [13.80.20.110] =&gt; (item={u&#39;regexp&#39;: u&#39;^session.*optional.*pam_motd.so.*&#39;, u&#39;line&#39;: u&#39;# MOTD DISABLED&#39;, u&#39;file&#39;: u&#39;/etc/pam.d/login&#39;})
changed: [13.80.20.110] =&gt; (item={u&#39;regexp&#39;: u&#39;^session.*optional.*pam_motd.so.*&#39;, u&#39;line&#39;: u&#39;# MOTD DISABLED&#39;, u&#39;file&#39;: u&#39;/etc/pam.d/sshd&#39;})

TASK [common : Install system specific tools] **********************************
ok: [13.80.20.110] =&gt; (item=[u&#39;ifupdown&#39;])

TASK [common : Ensure the interfaces directory exists] *************************
ok: [13.80.20.110]

TASK [common : Loopback for services configured] *******************************
changed: [13.80.20.110]

TASK [common : Loopback included into the network config] **********************
changed: [13.80.20.110]

RUNNING HANDLER [common : restart loopback] ************************************
changed: [13.80.20.110]

TASK [common : set_fact] *******************************************************
ok: [13.80.20.110]

TASK [common : set_fact] *******************************************************
skipping: [13.80.20.110]

TASK [common : Loopback included into the rc config] ***************************
skipping: [13.80.20.110]

TASK [common : Enable the gateway features] ************************************
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;YES&#34;&#39;, u&#39;param&#39;: u&#39;firewall_enable&#39;})
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;open&#34;&#39;, u&#39;param&#39;: u&#39;firewall_type&#39;})
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;YES&#34;&#39;, u&#39;param&#39;: u&#39;gateway_enable&#39;})
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;YES&#34;&#39;, u&#39;param&#39;: u&#39;natd_enable&#39;})
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;&#34;&#39;, u&#39;param&#39;: u&#39;natd_interface&#39;})
skipping: [13.80.20.110] =&gt; (item={u&#39;value&#39;: u&#39;&#34;-dynamic -m&#34;&#39;, u&#39;param&#39;: u&#39;natd_flags&#39;})

TASK [common : Install tools] **************************************************
changed: [13.80.20.110] =&gt; (item=[u&#39;git&#39;, u&#39;screen&#39;, u&#39;apparmor-utils&#39;, u&#39;uuid-runtime&#39;, u&#39;coreutils&#39;, u&#39;iptables-persistent&#39;, u&#39;cgroup-tools&#39;, u&#39;openssl&#39;])

TASK [common : Sysctl tuning] **************************************************
changed: [13.80.20.110] =&gt; (item={u&#39;item&#39;: u&#39;net.ipv4.ip_forward&#39;, u&#39;value&#39;: 1})
changed: [13.80.20.110] =&gt; (item={u&#39;item&#39;: u&#39;net.ipv4.conf.all.forwarding&#39;, u&#39;value&#39;: 1})
changed: [13.80.20.110] =&gt; (item={u&#39;item&#39;: u&#39;net.ipv6.conf.all.forwarding&#39;, u&#39;value&#39;: 1})

TASK [vpn : Ensure that the strongswan group exist] ****************************
changed: [13.80.20.110]

TASK [vpn : Ensure that the strongswan user exist] *****************************
changed: [13.80.20.110]

TASK [vpn : set_fact] **********************************************************
ok: [13.80.20.110]

TASK [vpn : Ubuntu | Install strongSwan] ***************************************
changed: [13.80.20.110]

TASK [vpn : Ubuntu | Enforcing ipsec with apparmor] ****************************
skipping: [13.80.20.110] =&gt; (item=/usr/lib/ipsec/charon)
skipping: [13.80.20.110] =&gt; (item=/usr/lib/ipsec/lookip)
skipping: [13.80.20.110] =&gt; (item=/usr/lib/ipsec/stroke)

TASK [vpn : Ubuntu | Enable services] ******************************************
ok: [13.80.20.110] =&gt; (item=apparmor)
ok: [13.80.20.110] =&gt; (item=strongswan)
ok: [13.80.20.110] =&gt; (item=netfilter-persistent)

TASK [vpn : Ubuntu | Ensure that the strongswan service directory exist] *******
changed: [13.80.20.110]

TASK [vpn : Ubuntu | Setup the cgroup limitations for the ipsec daemon] ********
changed: [13.80.20.110]

TASK [vpn : Iptables configured] ***********************************************
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/iptables/rules.v4&#39;, u&#39;src&#39;: u&#39;rules.v4.j2&#39;})

TASK [vpn : Iptables configured] ***********************************************
skipping: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/iptables/rules.v6&#39;, u&#39;src&#39;: u&#39;rules.v6.j2&#39;})

TASK [vpn : FreeBSD / HardenedBSD | Get the existing kernel parameters] ********
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Set the rebuild_needed fact] ***************
skipping: [13.80.20.110] =&gt; (item=IPSEC)
skipping: [13.80.20.110] =&gt; (item=IPSEC_NAT_T)
skipping: [13.80.20.110] =&gt; (item=crypto)

TASK [vpn : FreeBSD / HardenedBSD | Make the kernel config] ********************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Ensure the all options are enabled] ********
skipping: [13.80.20.110] =&gt; (item=options	IPSEC)
skipping: [13.80.20.110] =&gt; (item=options IPSEC_NAT_T)
skipping: [13.80.20.110] =&gt; (item=device	crypto)

TASK [vpn : HardenedBSD | Determine the sources] *******************************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD | Determine the sources] ***********************************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Increase the git postBuffer size] **********
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Fetching the sources...] *******************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Fetching the sources...] *******************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | The kernel is being built...] **************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | The kernel is being built...] **************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Reboot] ************************************
skipping: [13.80.20.110]

TASK [vpn : FreeBSD / HardenedBSD | Enable strongswan] *************************
skipping: [13.80.20.110]

TASK [vpn : Install strongSwan] ************************************************
ok: [13.80.20.110]

TASK [vpn : Setup the config files from our templates] *************************
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/strongswan.conf&#39;, u&#39;src&#39;: u&#39;strongswan.conf.j2&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0644&#39;, u&#39;owner&#39;: u&#39;root&#39;})
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/ipsec.conf&#39;, u&#39;src&#39;: u&#39;ipsec.conf.j2&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0644&#39;, u&#39;owner&#39;: u&#39;root&#39;})
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/ipsec.secrets&#39;, u&#39;src&#39;: u&#39;ipsec.secrets.j2&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0600&#39;, u&#39;owner&#39;: u&#39;strongswan&#39;})

TASK [vpn : Get loaded plugins] ************************************************
changed: [13.80.20.110]

TASK [vpn : Disable unneeded plugins] ******************************************
changed: [13.80.20.110] =&gt; (item=attr)
skipping: [13.80.20.110] =&gt; (item=sha2)
skipping: [13.80.20.110] =&gt; (item=revocation)
skipping: [13.80.20.110] =&gt; (item=kernel-netlink)
changed: [13.80.20.110] =&gt; (item=test-vectors)
changed: [13.80.20.110] =&gt; (item=md4)
changed: [13.80.20.110] =&gt; (item=rc2)
skipping: [13.80.20.110] =&gt; (item=pkcs12)
changed: [13.80.20.110] =&gt; (item=pkcs1)
skipping: [13.80.20.110] =&gt; (item=gcm)
changed: [13.80.20.110] =&gt; (item=xcbc)
skipping: [13.80.20.110] =&gt; (item=pgp)
skipping: [13.80.20.110] =&gt; (item=hmac)
skipping: [13.80.20.110] =&gt; (item=pkcs8)
changed: [13.80.20.110] =&gt; (item=agent)
changed: [13.80.20.110] =&gt; (item=sshkey)
skipping: [13.80.20.110] =&gt; (item=stroke)
skipping: [13.80.20.110] =&gt; (item=random)
skipping: [13.80.20.110] =&gt; (item=pubkey)
skipping: [13.80.20.110] =&gt; (item=aes)
skipping: [13.80.20.110] =&gt; (item=pkcs7)
changed: [13.80.20.110] =&gt; (item=resolve)
changed: [13.80.20.110] =&gt; (item=connmark)
changed: [13.80.20.110] =&gt; (item=constraints)
changed: [13.80.20.110] =&gt; (item=gmp)
changed: [13.80.20.110] =&gt; (item=md5)
changed: [13.80.20.110] =&gt; (item=fips-prf)
skipping: [13.80.20.110] =&gt; (item=pem)
changed: [13.80.20.110] =&gt; (item=sha1)
skipping: [13.80.20.110] =&gt; (item=nonce)
changed: [13.80.20.110] =&gt; (item=updown)
skipping: [13.80.20.110] =&gt; (item=openssl)
skipping: [13.80.20.110] =&gt; (item=x509)
changed: [13.80.20.110] =&gt; (item=dnskey)
skipping: [13.80.20.110] =&gt; (item=socket-default)

TASK [vpn : Ensure that required plugins are enabled] **************************
skipping: [13.80.20.110] =&gt; (item=attr)
changed: [13.80.20.110] =&gt; (item=sha2)
changed: [13.80.20.110] =&gt; (item=revocation)
changed: [13.80.20.110] =&gt; (item=kernel-netlink)
skipping: [13.80.20.110] =&gt; (item=test-vectors)
skipping: [13.80.20.110] =&gt; (item=md4)
skipping: [13.80.20.110] =&gt; (item=rc2)
changed: [13.80.20.110] =&gt; (item=pkcs12)
skipping: [13.80.20.110] =&gt; (item=pkcs1)
changed: [13.80.20.110] =&gt; (item=gcm)
skipping: [13.80.20.110] =&gt; (item=xcbc)
changed: [13.80.20.110] =&gt; (item=pgp)
changed: [13.80.20.110] =&gt; (item=hmac)
skipping: [13.80.20.110] =&gt; (item=agent)
changed: [13.80.20.110] =&gt; (item=pkcs8)
skipping: [13.80.20.110] =&gt; (item=sshkey)
changed: [13.80.20.110] =&gt; (item=stroke)
changed: [13.80.20.110] =&gt; (item=random)
changed: [13.80.20.110] =&gt; (item=pubkey)
changed: [13.80.20.110] =&gt; (item=aes)
changed: [13.80.20.110] =&gt; (item=pkcs7)
skipping: [13.80.20.110] =&gt; (item=resolve)
skipping: [13.80.20.110] =&gt; (item=connmark)
skipping: [13.80.20.110] =&gt; (item=constraints)
skipping: [13.80.20.110] =&gt; (item=gmp)
skipping: [13.80.20.110] =&gt; (item=md5)
skipping: [13.80.20.110] =&gt; (item=fips-prf)
changed: [13.80.20.110] =&gt; (item=pem)
skipping: [13.80.20.110] =&gt; (item=sha1)
changed: [13.80.20.110] =&gt; (item=nonce)
skipping: [13.80.20.110] =&gt; (item=updown)
changed: [13.80.20.110] =&gt; (item=openssl)
changed: [13.80.20.110] =&gt; (item=x509)
skipping: [13.80.20.110] =&gt; (item=dnskey)
changed: [13.80.20.110] =&gt; (item=socket-default)

TASK [vpn : Ensure the pki directory does not exist] ***************************
skipping: [13.80.20.110]

TASK [vpn : Ensure the pki directories exist] **********************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=ecparams)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=certs)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=crl)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=newcerts)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=private)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=reqs)

TASK [vpn : Ensure the files exist] ********************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=.rnd)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=private/.rnd)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=index.txt)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=index.txt.attr)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=serial)

TASK [vpn : Generate the openssl server configs] *******************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Build the CA pair] *************************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Copy the CA certificate] *******************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Generate the serial number] ****************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Build the server pair] *********************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Build the client&#39;s pair] *******************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Build the client&#39;s p12] ********************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Copy the p12 certificates] *****************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Get active users] **************************************************
changed: [13.80.20.110 -&gt; localhost]

TASK [vpn : Revoke non-existing users] *****************************************
skipping: [13.80.20.110] =&gt; (item=gabriele)
skipping: [13.80.20.110] =&gt; (item=davide)
skipping: [13.80.20.110] =&gt; (item=domenico)
skipping: [13.80.20.110] =&gt; (item=stefano)

TASK [vpn : Genereate new CRL file] ********************************************
skipping: [13.80.20.110]

TASK [vpn : Copy the CRL to the vpn server] ************************************
skipping: [13.80.20.110]

TASK [vpn : Copy the keys to the strongswan directory] *************************
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/ipsec.d/cacerts/ca.crt&#39;, u&#39;src&#39;: u&#39;configs/13.80.20.110/pki/cacert.pem&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0600&#39;, u&#39;owner&#39;: u&#39;strongswan&#39;})
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/ipsec.d/certs/13.80.20.110.crt&#39;, u&#39;src&#39;: u&#39;configs/13.80.20.110/pki/certs/13.80.20.110.crt&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0600&#39;, u&#39;owner&#39;: u&#39;strongswan&#39;})
changed: [13.80.20.110] =&gt; (item={u&#39;dest&#39;: u&#39;/etc/ipsec.d/private/13.80.20.110.key&#39;, u&#39;src&#39;: u&#39;configs/13.80.20.110/pki/private/13.80.20.110.key&#39;, u&#39;group&#39;: u&#39;root&#39;, u&#39;mode&#39;: u&#39;0600&#39;, u&#39;owner&#39;: u&#39;strongswan&#39;})

TASK [vpn : Register p12 PayloadContent] ***************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Set facts for mobileconfigs] ***************************************
ok: [13.80.20.110 -&gt; localhost]

TASK [vpn : Build the mobileconfigs] *******************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))

TASK [vpn : Build the strongswan app android config] ***************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))

TASK [vpn : Build the android helper html] *************************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=(censored due to no_log))

TASK [vpn : Build the client ipsec config file] ********************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Build the client ipsec secret file] ********************************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=gabriele)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=davide)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=domenico)
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=stefano)

TASK [vpn : Create the windows check file] *************************************
skipping: [13.80.20.110]

TASK [vpn : Check if the windows check file exists] ****************************
ok: [13.80.20.110 -&gt; localhost]

TASK [vpn : Build the windows client powershell script] ************************
skipping: [13.80.20.110] =&gt; (item=gabriele)
skipping: [13.80.20.110] =&gt; (item=davide)
skipping: [13.80.20.110] =&gt; (item=domenico)
skipping: [13.80.20.110] =&gt; (item=stefano)

TASK [vpn : Restrict permissions for the local private directories] ************
changed: [13.80.20.110 -&gt; localhost] =&gt; (item=configs/13.80.20.110)

RUNNING HANDLER [vpn : restart strongswan] *************************************
changed: [13.80.20.110]

RUNNING HANDLER [vpn : daemon-reload] ******************************************
changed: [13.80.20.110]

RUNNING HANDLER [vpn : restart iptables] ***************************************
changed: [13.80.20.110]

TASK [vpn : strongSwan started] ************************************************
ok: [13.80.20.110]

TASK [debug] *******************************************************************
ok: [13.80.20.110] =&gt; {
  &#34;msg&#34;: [
      [
          &#34;\&#34;#                          Congratulations!                            #\&#34;&#34;,
          &#34;\&#34;#                     Your Algo server is running.                     #\&#34;&#34;,
          &#34;\&#34;#    Config files and certificates are in the ./configs/ directory.    #\&#34;&#34;,
          &#34;\&#34;#              Go to https://whoer.net/ after connecting               #\&#34;&#34;,
          &#34;\&#34;#        and ensure that all your traffic passes through the VPN.      #\&#34;&#34;,
          &#34;\&#34;#               Local DNS resolver 172.16.0.1              #\&#34;&#34;,
          &#34;&#34;
      ],
      &#34;    \&#34;#                The p12 and SSH keys password for new users is *redacted*             #\&#34;\n&#34;,
      &#34;    &#34;,
      &#34;    \&#34;#      Shell access: ssh -i configs/algo.pem ubuntu@13.80.20.110        #\&#34;\n&#34;
  ]
}

TASK [Delete the CA key] *******************************************************
changed: [13.80.20.110 -&gt; localhost]

PLAY RECAP *********************************************************************
13.80.20.110               : ok=61   changed=47   unreachable=0    failed=0
localhost                  : ok=21   changed=12   unreachable=0    failed=0</pre></div>
<h2 id="client-configuration">Client configuration</h2>

<p><em>Currently using Debian stretch with xfce</em></p>

<p>In case it is necessary to reactivate the virtual environment:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> ~/algo
<span class="nb">source</span> env/bin/activate</code></pre></div>
<p>Use the playbook to configure the client</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ansible-playbook deploy_client.yml -e <span class="s1">&#39;client_ip=localhost vpn_user=gabriele server_ip=13.80.20.110 ssh_user=root&#39;</span> --ask-become-pass</code></pre></div>
<p>Start the conncetion</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1">#pick up config changes
</span><span class="c1"></span>sudo ipsec restart
<span class="c1">#start the ipsec tunnel
</span><span class="c1"></span>sudo ipsec up ikev2-13.80.20.110
<span class="c1">#shutdown the ipsec tunnel
</span><span class="c1"></span>sudo ipsec down ikev2-13.80.20.110</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>

<p>With Connection Manager edit the current network connection and set an MTU of 1438.
Restart the connection and reconnect.</p>

<h2 id="testing">Testing</h2>

<p><a href="https://whoer.net/">https://whoer.net/</a></p>

<p><a href="http://whatismyipaddress.com/">http://whatismyipaddress.com/</a></p>

<p><a href="https://diafygi.github.io/webrtc-ips/">https://diafygi.github.io/webrtc-ips/</a></p>
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.teosoft.it/post/2018-02-26-hugo-configure-a-site-part-3/" data-toggle="tooltip" data-placement="top" title="Hugo Configure a Site Part 3">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://www.teosoft.it/post/2018-03-02-hello-page-bundle/" data-toggle="tooltip" data-placement="top" title="Hello Page Bundle">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/gabrieleteotino" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://stackoverflow.com/users/2085504/deramko" title="StackOverflow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="https://www.teosoft.it/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://www.teosoft.it">Gabriele Teotino</a>
            
          

          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.teosoft.it/">Bluish capsule</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.36.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://www.teosoft.it/js/main.js"></script>
<script src="https://www.teosoft.it/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://www.teosoft.it/js/load-photoswipe.js"></script>


<script>
  (function() {
    var cx = '005185449088889757369:5o44h-2knna';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>





  </body>
</html>

